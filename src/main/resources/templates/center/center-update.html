<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>센터 정보 수정</title>
    <link rel="stylesheet" th:href="@{/center-skin/center-update.css}">
</head>
<body>
<div class="page-wrap">
<div class="upd-card">
    <h1>센터 정보 수정</h1>

    <!-- 수정 폼 -->
    <form th:action="@{'/api/v1/location/' + ${vm.id} + '/update'}" method="post" id="updateForm">

        <div class="form-group">
            <label for="locationName">센터명</label>
            <input type="text"
                   id="locationName"
                   name="locationName"
                   th:value="${vm.locationName.locationName}"
                   required>
            <div class="form-note">최대 60자까지 입력 가능합니다.</div>
        </div>

        <div class="form-group">
            <label for="locationNumber">전화번호</label>
            <input type="text"
                   id="locationNumber"
                   name="locationNumber"
                   th:value="${vm.locationNumber.locationNumber}"
                   readonly>
        </div>

        <div class="form-group">
            <label for="locationAddress">주소</label>
            <div class="address-group">
                <input type="text"
                       id="locationAddress"
                       name="locationAddress"
                       th:value="${vm.locationAddress.address}"
                       class="address-input"
                       readonly
                       required>
                <button type="button" onclick="searchAddress()" class="search-btn">주소 검색</button>
            </div>
            <div class="form-note">최대 200자까지 입력 가능합니다.</div>
        </div>

        <!-- 숨겨진 ID 필드 -->
        <input type="hidden" name="id" th:value="${vm.id}">

        
    </form>

    <!-- 액션 버튼 한 줄 정렬 -->
    <div class="update-actions-row">
        <button type="button" class="btn btn-update" onclick="document.getElementById('updateForm').requestSubmit()">수정하기</button>
        <button type="button" class="btn btn-cancel" onclick="history.back()">취소</button>
        <form th:action="@{'/api/v1/location/' + ${vm.id} + '/change/status'}" method="post" >
            <button type="submit" class="btn btn-delete">삭제하기</button>
        </form>
    </div>
</div>
</div>

<!-- 커스텀 모달은 공통 스크립트(center-delete.js)가 동적으로 주입합니다. -->

<!-- Daum 주소 검색 -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script>
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 도로명주소 우선, 없으면 지번주소 사용
                const fullAddress = data.roadAddress || data.jibunAddress || data.address;
                document.getElementById("locationAddress").value = fullAddress;
            }
        }).open();
    }

    // readonly 필드 클릭 시에도 주소 검색 가능하도록
    document.getElementById('locationAddress').addEventListener('click', function() {
        searchAddress();
    });

    // 폼 제출 이벤트 처리
    document.getElementById('updateForm').addEventListener('submit', function(e) {
        e.preventDefault(); // 기본 폼 제출 방지

        const formData = new FormData(this);
        const actionUrl = this.action;

        fetch(actionUrl, {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    // 성공 시 성공 메시지 표시 후 리다이렉트
                    showAlert('success', '성공', '센터 정보가 성공적으로 수정되었습니다.', function() {
                        window.location.href = '/center/view/' + formData.get('id');
                    });
                } else {
                    // 실패 시 에러 메시지 표시 (현재 페이지 유지)
                    showAlert('error', '오류', 'DB 오류가 발생했습니다. 다시 시도해 주세요.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('error', '오류', '요청 처리 중 오류가 발생했습니다. 다시 시도해 주세요.');
            });
    });

    // showAlert / closeAlert / showConfirm / closeConfirm 는 공통 스크립트에서 제공됩니다.
    // center-delete.js - 센터 삭제 기능

    document.addEventListener('DOMContentLoaded', function() {
        // 삭제 폼 찾기
        const deleteForm = document.querySelector('form[action*="/change/status"]');

        if (deleteForm) {
            // 기존 form submit 이벤트를 가로채기
            deleteForm.addEventListener('submit', function(e) {
                e.preventDefault(); // 기본 form 제출 방지

                const actionUrl = this.action;

                showConfirm('삭제 확인', '정말로 이 센터를 삭제하시겠습니까?', function () {
                    fetch(actionUrl, {
                        method: 'POST',
                        body: new FormData()
                    })
                        .then(response => {
                            if (response.ok) {
                                // 성공 시: 알림 후 적절한 페이지로 이동
                                function getRedirectUrl() {
                                    try {
                                        const ref = document.referrer;
                                        const sameOrigin = ref && new URL(ref, location.origin).origin === location.origin;
                                        if (sameOrigin && /(center\/main|center\/view\/quarter)/.test(ref)) {
                                            return ref;
                                        }
                                    } catch (e) {}
                                    return '/center/main';
                                }

                                const redirectTo = getRedirectUrl();
                                showAlert('success', '삭제 완료', '센터가 성공적으로 삭제되었습니다.', function() {
                                    window.location.href = redirectTo;
                                });
                                setTimeout(() => { try { closeAlert(); } catch(e) {} }, 1000);
                            } else {
                                showAlert('error', '삭제 실패', '센터 삭제 중 오류가 발생했습니다. 다시 시도해 주세요.');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showAlert('error', '네트워크 오류', '서버와의 통신 중 오류가 발생했습니다.');
                        });
                });
            });
        }
    });

    // 알림 함수들은 이미 center-update.html에 있으므로 별도로 정의하지 않음
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
<script th:src="@{/center-skin/center-update.js}"></script>
<script th:src="@{/center-skin/center-delete.js}"></script>
</body>
</html>